<!DOCTYPE html>

<head>
  <title>PID Ball Balancer</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

  <style>
    #canvas {
      border: 1px solid black;
      width: 410px;
      height: 410px;
    }
  </style>
</head>

<body>
  <h1>Welcome to the PID Ball Balancer!</h1>

  <p>
    Just choose your mode and try it out.
  </p>

  <p>
    <input type="radio" id="radio-center" name="mode" value="center" checked="checked" />
    <label for="radio-center"> Center</label>
    <br />
    <input type="radio" id="radio-free" name="mode" value="free" />
    <label for="radio-free"> Choose your position</label>
  </p>

  <canvas id="canvas" style="display: none;"></canvas>
  <p id="position-info" style="display: none;">Current position: <span id="position">(none)</span></p>

  <p>
    <button id="start">Start</button>
    <button id="stop">Stop</button>
    Status: <span id="status">stopped</span>
  </p>

  <script>
    let pos = null;
    const canvas = document.getElementById('canvas')
    const canvasCtx = canvas.getContext('2d')

    canvas.width = 410
    canvas.height = 410

    function setStatus(status) {
      $('#status').text(status)
    }

    function clearCanvas() {
      canvasCtx.clearRect(0, 0, canvas.width, canvas.height)
    }

    // Showing/hiding the "canvas"

    $('#radio-free').click(() => {
      $('#canvas').show()
      $('#position-info').show()
    })

    $('#radio-center').click(() => {
      $('#canvas').hide()
      $('#position-info').hide()
      $('#position').text('(none)')
      pos = null
      clearCanvas()
    })

    // Handling the current position

    $('#canvas').on('click', function (e) {
      clearCanvas()

      pos = { x: e.offsetX, y: e.offsetY }
      $('#position').text(`(${pos.x}, ${pos.y})`)

      const radius = 10
      canvasCtx.beginPath()
      canvasCtx.fillStyle = '#000'
      canvasCtx.arc(pos.x, pos.y, radius, 0, 2 * Math.PI)
      canvasCtx.fill()
    })

    // Handling buttons

    $('#start').click(() => {
      const mode = $('input[name="mode"]:checked').val()
      if (mode === 'center') {
        $.get('/pid-center')
        setStatus('running')
      } else if (pos !== null) {
        $.get(`/pid-position?posx=${pos.x}&posy=${pos.y}`)
        setStatus('running')
      }
    })

    $('#stop').click(() => {
      $.get('/pid-stop')
      setStatus('stopped')
    })
  </script>
</body>